#!/usr/bin/env bash
#
# =============================================================================
# Скрипт объединения результатов анализа myAnalysis в один ROOT-файл
# =============================================================================
#
# Назначение:
#   - Находит все файлы ana_*.root в директории результатов конкретного процесса
#   - Объединяет их в один итоговый файл с помощью hadd
#   - Сохраняет результат в корневой директории анализа (на уровень выше results/)
#
# Использование:
#   ./merge_results.sh -p PROCESS_NAME [-o ANALYSIS_ROOT] [-h]
#
# Примеры:
#   ./merge_results.sh -p E240_qqHinvi
#   ./merge_results.sh -p E240_qqHX -o /cefs/higgs/kositsin/CEPCSW-tutorial/Analysis/myAnalysis
#
# =============================================================================
# ──────────────────────────────────────────────────────────────────────────────
#          Функция вывода справки
# ──────────────────────────────────────────────────────────────────────────────
show_help() {
cat << EOF
Скрипт для объединения результатов анализа myAnalysis в один ROOT-файл
Использование:
$(basename "$0") -p PROCESS_NAME [OPTIONS]

Обязательные параметры:
-p, --process     Название процесса (например, E240_qqHinvi, E240_qqHX)

Опциональные параметры:
-o, --analysis-root   Корневая директория анализа
(по умолчанию: /cefs/higgs/kositsin/CEPCSW-tutorial/Analysis/myAnalysis)
-h, --help            Показать эту справку

Примеры:
# Объединить файлы для процесса H->invisible
$(basename "$0") -p E240_qqHinvi

# Объединить файлы для процесса H->inclusive
$(basename "$0") -p E240_qqHX

# С указанием полной пути к директории анализа
$(basename "$0") -p E240_qqHX -o /path/to/analysis
EOF
}

# ──────────────────────────────────────────────────────────────────────────────
#          Параметры по умолчанию
# ──────────────────────────────────────────────────────────────────────────────
ANALYSIS_ROOT="/cefs/higgs/kositsin/CEPCSW-tutorial/Analysis/myAnalysis"
PROCESS_NAME=""

# ──────────────────────────────────────────────────────────────────────────────
#          Парсинг аргументов командной строки
# ──────────────────────────────────────────────────────────────────────────────
while [[ $# -gt 0 ]]; do
case $1 in
-p|--process)
PROCESS_NAME="$2"
shift 2
;;
-o|--analysis-root)
ANALYSIS_ROOT="$2"
shift 2
;;
-h|--help)
show_help
exit 0
;;
*)
echo "Ошибка: неизвестный параметр '$1'"
echo "Используйте -h для просмотра справки"
exit 1
;;
esac
done

# ──────────────────────────────────────────────────────────────────────────────
#          Проверка обязательных параметров
# ──────────────────────────────────────────────────────────────────────────────
if [ -z "$PROCESS_NAME" ]; then
echo "Ошибка: не указано название процесса (-p)"
echo "Используйте -h для просмотра справки"
exit 1
fi

# ──────────────────────────────────────────────────────────────────────────────
#          Внутренние переменные
# ──────────────────────────────────────────────────────────────────────────────
# Директория с результатами анализа (отдельная для каждого процесса)
RESULTS_DIR="${ANALYSIS_ROOT}/results/${PROCESS_NAME}"
# Имя итогового объединённого файла
MERGED_FILENAME="merged_${PROCESS_NAME}.root"
# Полный путь к итоговому файлу (в корне проекта, а не внутри results/)
MERGED_FILE="${ANALYSIS_ROOT}/${MERGED_FILENAME}"

# ──────────────────────────────────────────────────────────────────────────────
#          Проверки перед началом работы
# ──────────────────────────────────────────────────────────────────────────────
# Проверяем существование директории с результатами
if [ ! -d "$RESULTS_DIR" ]; then
echo "Ошибка: директория с результатами не найдена"
echo "Ожидаемый путь: $RESULTS_DIR"
echo
echo "Возможные причины:"
echo "  1. Задания ещё не завершили работу"
echo "  2. Неправильно указано имя процесса"
echo "  3. Неправильно указана директория анализа"
exit 1
fi

# Проверяем, есть ли вообще файлы для объединения
shopt -s nullglob  # чтобы *.root не разворачивался в буквальную строку, если файлов нет
ana_files=("${RESULTS_DIR}"/ana_"${PROCESS_NAME}"_*.root)
if [ ${#ana_files[@]} -eq 0 ]; then
echo "Ошибка: в директории не найдено ни одного файла вида ana_${PROCESS_NAME}_*.root"
echo "Путь: $RESULTS_DIR"
exit 1
fi
printf "Найдено файлов для объединения: %d\n" "${#ana_files[@]}"

# ──────────────────────────────────────────────────────────────────────────────
#          Объединение файлов
# ──────────────────────────────────────────────────────────────────────────────
echo
echo "Объединяем файлы..."
echo "Источник:   ${RESULTS_DIR}/ana_${PROCESS_NAME}_*.root"
echo "Результат:  ${MERGED_FILE}"
hadd -f "$MERGED_FILE" "${ana_files[@]}" || {
echo "Ошибка: hadd завершился с ошибкой"
echo "Возможно, некоторые файлы повреждены или имеют несовместимую структуру"
exit 1
}

# Проверка успешности создания файла
if [ -f "$MERGED_FILE" ] && [ -s "$MERGED_FILE" ]; then
echo
echo "Объединение успешно завершено!"
echo "Итоговый файл: ${MERGED_FILE}"
echo "Размер: $(du -h "$MERGED_FILE" | cut -f1)"
else
echo "Ошибка: итоговый файл не создан или пустой"
exit 1
fi

echo
echo "Готово."
