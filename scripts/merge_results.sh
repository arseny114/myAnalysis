#!/usr/bin/env bash
#
# =============================================================================
# Скрипт объединения результатов анализа myAnalysis в один ROOT-файл
# =============================================================================
#
# Назначение:
#   - Находит все файлы ana_*.root в директории результатов конкретного процесса
#   - Объединяет их в один итоговый файл с помощью hadd
#   - Сохраняет результат в корневой директории анализа (на уровень выше results/)
#
# =============================================================================

# ──────────────────────────────────────────────────────────────────────────────
#          Основные настраиваемые параметры
# ──────────────────────────────────────────────────────────────────────────────

# Название процесса (должно совпадать с именем, используемым при генерации файлов)
PROCESS="E240_qqHinvi"

# Корневая директория всего проекта анализа
ANALYSIS_ROOT="/cefs/higgs/kositsin/CEPCSW-tutorial/Analysis/myAnalysis"

# Директория с результатами анализа (отдельная для каждого процесса)
RESULTS_DIR="${ANALYSIS_ROOT}/results/${PROCESS}"

# Имя итогового объединённого файла
MERGED_FILENAME="merged_${PROCESS}.root"

# Полный путь к итоговому файлу (в корне проекта, а не внутри results/)
MERGED_FILE="${ANALYSIS_ROOT}/${MERGED_FILENAME}"

# ──────────────────────────────────────────────────────────────────────────────
#          Проверки перед началом работы
# ──────────────────────────────────────────────────────────────────────────────

# Проверяем существование директории с результатами
if [ ! -d "$RESULTS_DIR" ]; then
    echo "Ошибка: директория с результатами не найдена"
    echo "Ожидаемый путь: $RESULTS_DIR"
    exit 1
fi

# Проверяем, есть ли вообще файлы для объединения
shopt -s nullglob  # чтобы *.root не разворачивался в буквальную строку, если файлов нет
ana_files=("${RESULTS_DIR}"/ana_"${PROCESS}"_*.root)

if [ ${#ana_files[@]} -eq 0 ]; then
    echo "Ошибка: в директории не найдено ни одного файла вида ana_${PROCESS}_*.root"
    echo "Путь: $RESULTS_DIR"
    exit 1
fi

printf "Найдено файлов для объединения: %d\n" "${#ana_files[@]}"

# ──────────────────────────────────────────────────────────────────────────────
#          Объединение файлов
# ──────────────────────────────────────────────────────────────────────────────

echo
echo "Объединяем файлы..."
echo "Источник:   ${RESULTS_DIR}/ana_${PROCESS}_*.root"
echo "Результат:  ${MERGED_FILE}"

hadd -f "$MERGED_FILE" "${ana_files[@]}" || {
    echo "Ошибка: hadd завершился с ошибкой"
    echo "Возможно, некоторые файлы повреждены или имеют несовместимую структуру"
    exit 1
}

# Проверка успешности создания файла
if [ -f "$MERGED_FILE" ] && [ -s "$MERGED_FILE" ]; then
    echo
    echo "Объединение успешно завершено!"
    echo "Итоговый файл: ${MERGED_FILE}"
    echo "Размер: $(du -h "$MERGED_FILE" | cut -f1)"
else
    echo "Ошибка: итоговый файл не создан или пустой"
    exit 1
fi

echo
echo "Готово."
